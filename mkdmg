#!/bin/sh

REPO_VERSION=$(hg id -n)
REPO_VERSION="rev${REPO_VERSION%+}"
VERSION=$1
if test -z "$VERSION"; then
	echo "missing version"
	exit 2
fi

echo "Building version $VERSION (repo version $REPO_VERSION)"

#sed -e "s/@VERSION@/${VERSION}/g" -e "s/@REPO_VERSION@/rev${REPO_VERSION}/g" Viltvodle/Viltvodle-Info.plist

xcodebuild -scheme archive VERSION=$VERSION REPO_VERSION=$REPO_VERSION || exit

TMPDMG=viltvodle-tmp.dmg
/bin/rm -f $TMPDMG

die()
{
    echo "$1"
    /bin/rm -f $TMPDMG
    exit 1
}

APP=build/Release/Viltvodle.app

echo "Stripping binary"
strip $APP/Contents/MacOS/Viltvodle
strip $APP/Contents/MacOS/vivo

VOL="viltvodle-$VERSION"
DMG="$VOL.dmg"
echo "Creating disk image $VOL"

# clean up if we're interrupted
trap 'die Interrupted' 2 3 15

# Create the source folder and copy the application there.
DMG_SOURCE="Viltvodle $VERSION"
mkdir "$DMG_SOURCE" || die "failed to create .dmg source folder"
/bin/cp -R $APP "$DMG_SOURCE" || die "failed to copy application to the .dmg source folder"
ln -s /Applications "$DMG_SOURCE/Applications"

# Create a disk image of the source folder and compress it.
hdiutil makehybrid -o "$TMPDMG" "$DMG_SOURCE" -hfs
hdiutil convert -format UDBZ "$TMPDMG" -o "$DMG"

/bin/rm -f $TMPDMG
ls -lh "$DMG"

exit 0
#### Create and sign a zip file for automatic updates.

APPCAST_BASE="http://appcast.vibrant-editor.com"
DOWNLOAD_BASE="http://download.vibrant-editor.com"

KSIZE=$(du -ks "$APP" | cut -f1)
SIZE=$(($KSIZE * 1024))
SIGNATURE=$(/usr/bin/openssl dgst -sha1 -binary < "$DMG" | /usr/bin/openssl dgst -dss1 -sign sparkle_priv.pem | /usr/bin/openssl enc -base64)

cat > $VOL.xml <<EOF
<item>
    <title>Version $VERSION</title>
    <sparkle:releaseNotesLink>
        $APPCAST_BASE/version-$VERSION.html
    </sparkle:releaseNotesLink>
    <pubDate>$(LC_TIME=en_US date +"%a, %d %b %G %T %z")</pubDate>
    <enclosure url="$DOWNLOAD_BASE/$DMG"
               sparkle:version="$REPO_VERSION"
               sparkle:shortVersionString="$VERSION"
               sparkle:dsaSignature="$SIGNATURE"
               length="$SIZE"
               type="application/octet-stream" />
</item>
EOF
cat "$VOL.xml"

echo "scp $DMG vibrant-editor.com:/var/www/download"

